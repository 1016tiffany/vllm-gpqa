import re
import matplotlib.pyplot as plt

# Full expert entropy list provided by the user (512 entries)
expert_text = """
layer_10_expert_5	0.000
layer_8_expert_13	0.586
layer_22_expert_4	0.773
layer_25_expert_10	0.817
layer_25_expert_8	0.845
layer_27_expert_12	0.847
layer_5_expert_10	0.898
layer_4_expert_14	1.014
layer_7_expert_2	1.058
layer_26_expert_0	1.063
layer_29_expert_14	1.117
layer_17_expert_5	1.168
layer_26_expert_4	1.176
layer_27_expert_11	1.193
layer_27_expert_4	1.221
layer_23_expert_9	1.229
layer_13_expert_14	1.265
layer_2_expert_12	1.294
layer_25_expert_9	1.308
layer_2_expert_2	1.331
layer_24_expert_13	1.353
layer_20_expert_6	1.371
layer_2_expert_8	1.379
layer_2_expert_4	1.382
layer_20_expert_2	1.398
layer_3_expert_11	1.404
layer_16_expert_12	1.406
layer_2_expert_0	1.477
layer_25_expert_11	1.504
layer_24_expert_6	1.504
layer_17_expert_9	1.509
layer_26_expert_14	1.533
layer_12_expert_8	1.537
layer_22_expert_13	1.539
layer_2_expert_11	1.543
layer_27_expert_8	1.564
layer_16_expert_1	1.565
layer_1_expert_6	1.566
layer_28_expert_8	1.599
layer_26_expert_12	1.648
layer_1_expert_13	1.655
layer_8_expert_1	1.678
layer_5_expert_11	1.690
layer_21_expert_5	1.695
layer_5_expert_2	1.706
layer_18_expert_7	1.708
layer_1_expert_3	1.717
layer_4_expert_7	1.729
layer_28_expert_7	1.737
layer_3_expert_2	1.750
layer_4_expert_6	1.752
layer_24_expert_5	1.752
layer_17_expert_3	1.754
layer_19_expert_0	1.755
layer_2_expert_1	1.757
layer_26_expert_8	1.761
layer_24_expert_8	1.773
layer_5_expert_14	1.779
layer_24_expert_15	1.789
layer_28_expert_2	1.805
layer_18_expert_11	1.821
layer_29_expert_3	1.832
layer_19_expert_11	1.853
layer_9_expert_14	1.883
layer_4_expert_10	1.886
layer_14_expert_10	1.888
layer_9_expert_13	1.889
layer_3_expert_7	1.889
layer_23_expert_15	1.890
layer_26_expert_5	1.896
layer_7_expert_11	1.898
layer_28_expert_13	1.911
layer_1_expert_9	1.915
layer_31_expert_6	1.944
layer_21_expert_8	1.946
layer_28_expert_3	1.956
layer_3_expert_13	1.958
layer_30_expert_2	1.960
layer_27_expert_5	1.967
layer_3_expert_8	1.967
layer_1_expert_11	1.970
layer_13_expert_13	1.976
layer_4_expert_13	1.976
layer_20_expert_8	1.979
layer_24_expert_10	1.993
layer_7_expert_3	1.994
layer_21_expert_0	1.997
layer_8_expert_5	2.002
layer_12_expert_12	2.018
layer_30_expert_14	2.019
layer_8_expert_6	2.023
layer_19_expert_15	2.026
layer_18_expert_0	2.028
layer_4_expert_11	2.035
layer_4_expert_0	2.037
layer_8_expert_2	2.043
layer_30_expert_10	2.065
layer_22_expert_12	2.088
layer_1_expert_1	2.101
layer_13_expert_3	2.113
layer_23_expert_12	2.126
layer_25_expert_2	2.134
layer_28_expert_5	2.138
layer_24_expert_3	2.141
layer_24_expert_12	2.141
layer_6_expert_7	2.152
layer_10_expert_4	2.164
layer_6_expert_4	2.165
layer_26_expert_9	2.166
layer_22_expert_6	2.176
layer_21_expert_14	2.181
layer_19_expert_7	2.188
layer_17_expert_4	2.190
layer_29_expert_11	2.195
layer_25_expert_15	2.204
layer_9_expert_10	2.207
layer_26_expert_1	2.212
layer_11_expert_7	2.213
layer_0_expert_9	2.215
layer_4_expert_15	2.222
layer_6_expert_6	2.227
layer_10_expert_0	2.236
layer_14_expert_6	2.240
layer_14_expert_15	2.241
layer_20_expert_13	2.242
layer_8_expert_14	2.242
layer_12_expert_13	2.247
layer_5_expert_5	2.247
layer_20_expert_4	2.247
layer_5_expert_7	2.255
layer_11_expert_6	2.260
layer_19_expert_3	2.261
layer_5_expert_0	2.275
layer_4_expert_2	2.279
layer_23_expert_3	2.279
layer_2_expert_13	2.284
layer_19_expert_5	2.290
layer_27_expert_2	2.291
layer_27_expert_9	2.298
layer_16_expert_10	2.300
layer_13_expert_15	2.306
layer_26_expert_15	2.314
layer_24_expert_7	2.314
layer_0_expert_11	2.320
layer_22_expert_0	2.322
layer_18_expert_14	2.323
layer_28_expert_9	2.324
layer_11_expert_12	2.326
layer_5_expert_15	2.326
layer_12_expert_1	2.327
layer_0_expert_13	2.334
layer_22_expert_7	2.336
layer_18_expert_15	2.342
layer_5_expert_1	2.345
layer_26_expert_11	2.354
layer_3_expert_9	2.362
layer_17_expert_14	2.364
layer_15_expert_9	2.365
layer_3_expert_15	2.366
layer_25_expert_13	2.370
layer_6_expert_0	2.377
layer_26_expert_2	2.380
layer_25_expert_0	2.381
layer_22_expert_1	2.381
layer_21_expert_4	2.385
layer_22_expert_14	2.401
layer_22_expert_8	2.409
layer_18_expert_5	2.412
layer_30_expert_13	2.416
layer_1_expert_15	2.433
layer_23_expert_5	2.441
layer_7_expert_1	2.450
layer_6_expert_1	2.451
layer_7_expert_6	2.453
layer_24_expert_1	2.454
layer_6_expert_12	2.457
layer_29_expert_10	2.457
layer_6_expert_2	2.465
layer_1_expert_10	2.466
layer_11_expert_14	2.471
layer_21_expert_9	2.476
layer_3_expert_5	2.477
layer_24_expert_11	2.480
layer_7_expert_12	2.493
layer_24_expert_14	2.500
layer_23_expert_14	2.515
layer_20_expert_14	2.516
layer_22_expert_3	2.519
layer_9_expert_4	2.520
layer_11_expert_10	2.521
layer_11_expert_0	2.531
layer_27_expert_15	2.533
layer_17_expert_6	2.537
layer_16_expert_15	2.537
layer_12_expert_5	2.539
layer_19_expert_10	2.543
layer_27_expert_0	2.545
layer_4_expert_8	2.551
layer_27_expert_1	2.554
layer_14_expert_8	2.561
layer_20_expert_5	2.564
layer_0_expert_1	2.567
layer_2_expert_5	2.568
layer_6_expert_13	2.576
layer_14_expert_7	2.578
layer_23_expert_8	2.585
layer_28_expert_12	2.590
layer_23_expert_11	2.595
layer_15_expert_0	2.600
layer_16_expert_14	2.610
layer_29_expert_5	2.613
layer_7_expert_14	2.614
layer_15_expert_10	2.631
layer_14_expert_13	2.633
layer_29_expert_13	2.637
layer_28_expert_11	2.638
layer_29_expert_4	2.639
layer_17_expert_7	2.656
layer_21_expert_13	2.656
layer_23_expert_13	2.657
layer_10_expert_1	2.662
layer_29_expert_6	2.663
layer_1_expert_5	2.664
layer_19_expert_14	2.670
layer_11_expert_11	2.671
layer_20_expert_1	2.671
layer_22_expert_10	2.674
layer_19_expert_9	2.679
layer_18_expert_4	2.681
layer_17_expert_0	2.683
layer_15_expert_13	2.684
layer_1_expert_0	2.688
layer_20_expert_11	2.702
layer_1_expert_4	2.707
layer_29_expert_9	2.710
layer_9_expert_1	2.711
layer_18_expert_10	2.713
layer_30_expert_5	2.719
layer_30_expert_7	2.720
layer_30_expert_9	2.720
layer_26_expert_3	2.734
layer_17_expert_13	2.736
layer_8_expert_0	2.744
layer_0_expert_10	2.761
layer_10_expert_15	2.763
layer_20_expert_12	2.765
layer_21_expert_15	2.769
layer_12_expert_3	2.774
layer_19_expert_4	2.775
layer_14_expert_12	2.788
layer_27_expert_14	2.788
layer_16_expert_4	2.793
layer_12_expert_0	2.802
layer_21_expert_10	2.803
layer_25_expert_3	2.807
layer_16_expert_5	2.811
layer_10_expert_12	2.821
layer_15_expert_11	2.822
layer_9_expert_6	2.830
layer_25_expert_6	2.830
layer_16_expert_2	2.840
layer_26_expert_6	2.841
layer_20_expert_9	2.861
layer_14_expert_4	2.865
layer_16_expert_3	2.867
layer_22_expert_11	2.869
layer_3_expert_10	2.874
layer_29_expert_1	2.880
layer_11_expert_9	2.883
layer_9_expert_0	2.884
layer_23_expert_10	2.888
layer_23_expert_2	2.889
layer_27_expert_7	2.894
layer_8_expert_15	2.894
layer_7_expert_7	2.907
layer_19_expert_13	2.912
layer_14_expert_1	2.912
layer_18_expert_13	2.914
layer_2_expert_14	2.915
layer_25_expert_4	2.918
layer_8_expert_12	2.919
layer_0_expert_3	2.921
layer_20_expert_3	2.922
layer_4_expert_5	2.922
layer_8_expert_3	2.923
layer_25_expert_12	2.925
layer_7_expert_10	2.926
layer_10_expert_14	2.928
layer_12_expert_15	2.928
layer_24_expert_0	2.929
layer_18_expert_12	2.929
layer_9_expert_2	2.934
layer_14_expert_3	2.938
layer_30_expert_1	2.939
layer_23_expert_4	2.941
layer_14_expert_0	2.947
layer_14_expert_11	2.947
layer_23_expert_6	2.948
layer_3_expert_3	2.949
layer_11_expert_15	2.950
layer_5_expert_12	2.956
layer_13_expert_2	2.956
layer_2_expert_7	2.957
layer_15_expert_2	2.958
layer_28_expert_15	2.964
layer_5_expert_3	2.967
layer_0_expert_4	2.968
layer_16_expert_8	2.969
layer_10_expert_8	2.972
layer_3_expert_4	2.975
layer_9_expert_3	2.977
layer_3_expert_0	2.979
layer_11_expert_2	2.983
layer_11_expert_13	2.984
layer_18_expert_9	2.989
layer_16_expert_0	2.993
layer_15_expert_7	2.995
layer_6_expert_10	3.029
layer_30_expert_0	3.029
layer_12_expert_11	3.032
layer_30_expert_12	3.033
layer_28_expert_10	3.042
layer_12_expert_10	3.051
layer_13_expert_4	3.053
layer_26_expert_7	3.059
layer_28_expert_4	3.060
layer_10_expert_7	3.062
layer_23_expert_7	3.067
layer_7_expert_5	3.070
layer_22_expert_5	3.074
layer_17_expert_1	3.075
layer_13_expert_0	3.077
layer_13_expert_6	3.083
layer_13_expert_9	3.094
layer_13_expert_1	3.095
layer_21_expert_12	3.096
layer_16_expert_11	3.097
layer_7_expert_9	3.108
layer_5_expert_8	3.109
layer_0_expert_15	3.114
layer_8_expert_10	3.117
layer_15_expert_3	3.119
layer_26_expert_10	3.123
layer_16_expert_13	3.124
layer_2_expert_6	3.128
layer_7_expert_0	3.129
layer_15_expert_12	3.132
layer_11_expert_8	3.135
layer_2_expert_9	3.137
layer_17_expert_12	3.138
layer_29_expert_0	3.142
layer_18_expert_3	3.152
layer_1_expert_2	3.152
layer_21_expert_1	3.155
layer_12_expert_4	3.155
layer_6_expert_14	3.166
layer_18_expert_1	3.169
layer_9_expert_9	3.169
layer_14_expert_9	3.170
layer_29_expert_8	3.171
layer_13_expert_12	3.172
layer_30_expert_6	3.178
layer_10_expert_6	3.178
layer_10_expert_10	3.181
layer_5_expert_13	3.183
layer_9_expert_11	3.189
layer_5_expert_9	3.190
layer_27_expert_10	3.195
layer_2_expert_15	3.196
layer_1_expert_14	3.198
layer_11_expert_5	3.201
layer_20_expert_10	3.205
layer_15_expert_4	3.206
layer_20_expert_15	3.208
layer_13_expert_11	3.212
layer_23_expert_1	3.216
layer_31_expert_12	3.217
layer_0_expert_5	3.219
layer_1_expert_8	3.243
layer_15_expert_5	3.244
layer_6_expert_9	3.246
layer_24_expert_2	3.246
layer_31_expert_3	3.255
layer_8_expert_11	3.260
layer_7_expert_4	3.263
layer_21_expert_6	3.264
layer_6_expert_11	3.266
layer_24_expert_9	3.274
layer_14_expert_14	3.285
layer_30_expert_8	3.287
layer_28_expert_14	3.296
layer_31_expert_0	3.297
layer_27_expert_6	3.299
layer_4_expert_12	3.300
layer_21_expert_3	3.301
layer_0_expert_8	3.301
layer_31_expert_13	3.304
layer_5_expert_6	3.304
layer_25_expert_7	3.314
layer_18_expert_2	3.315
layer_10_expert_13	3.318
layer_7_expert_8	3.320
layer_4_expert_4	3.321
layer_3_expert_14	3.327
layer_0_expert_14	3.330
layer_19_expert_2	3.332
layer_9_expert_5	3.336
layer_29_expert_12	3.343
layer_3_expert_6	3.345
layer_0_expert_6	3.345
layer_10_expert_2	3.352
layer_0_expert_2	3.355
layer_19_expert_8	3.359
layer_6_expert_3	3.364
layer_13_expert_8	3.369
layer_3_expert_12	3.370
layer_21_expert_7	3.381
layer_30_expert_3	3.383
layer_12_expert_14	3.383
layer_9_expert_7	3.386
layer_13_expert_5	3.387
layer_4_expert_1	3.389
layer_30_expert_4	3.394
layer_9_expert_15	3.394
layer_13_expert_7	3.396
layer_11_expert_1	3.403
layer_6_expert_15	3.405
layer_16_expert_7	3.407
layer_25_expert_1	3.421
layer_29_expert_7	3.426
layer_30_expert_15	3.427
layer_16_expert_6	3.432
layer_22_expert_2	3.439
layer_27_expert_3	3.449
layer_22_expert_9	3.449
layer_0_expert_12	3.462
layer_20_expert_7	3.467
layer_11_expert_3	3.467
layer_12_expert_2	3.467
layer_5_expert_4	3.475
layer_29_expert_2	3.477
layer_27_expert_13	3.489
layer_3_expert_1	3.490
layer_31_expert_8	3.495
layer_31_expert_4	3.504
layer_4_expert_9	3.510
layer_2_expert_10	3.515
layer_8_expert_7	3.516
layer_10_expert_11	3.525
layer_10_expert_3	3.530
layer_9_expert_8	3.534
layer_20_expert_0	3.535
layer_6_expert_5	3.537
layer_8_expert_4	3.551
layer_8_expert_9	3.552
layer_22_expert_15	3.552
layer_15_expert_15	3.559
layer_4_expert_3	3.563
layer_17_expert_10	3.563
layer_18_expert_8	3.570
layer_23_expert_0	3.573
layer_24_expert_4	3.580
layer_17_expert_2	3.580
layer_11_expert_4	3.581
layer_30_expert_11	3.591
layer_7_expert_13	3.596
layer_29_expert_15	3.600
layer_21_expert_2	3.606
layer_8_expert_8	3.612
layer_12_expert_9	3.618
layer_1_expert_12	3.624
layer_15_expert_6	3.657
layer_16_expert_9	3.670
layer_28_expert_6	3.676
layer_1_expert_7	3.680
layer_25_expert_14	3.684
layer_25_expert_5	3.686
layer_28_expert_1	3.688
layer_2_expert_3	3.691
layer_17_expert_15	3.694
layer_19_expert_6	3.694
layer_9_expert_12	3.706
layer_13_expert_10	3.708
layer_12_expert_7	3.717
layer_10_expert_9	3.717
layer_14_expert_5	3.725
layer_15_expert_8	3.740
layer_28_expert_0	3.753
layer_17_expert_8	3.771
layer_19_expert_12	3.772
layer_7_expert_15	3.790
layer_15_expert_1	3.801
layer_19_expert_1	3.839
layer_17_expert_11	3.844
layer_0_expert_0	3.847
layer_0_expert_7	3.855
layer_26_expert_13	3.860
layer_31_expert_5	3.874
layer_31_expert_2	3.889
layer_18_expert_6	3.907
layer_31_expert_15	3.946
layer_31_expert_1	3.947
layer_14_expert_2	3.950
layer_6_expert_8	3.972
layer_31_expert_14	4.046
layer_31_expert_10	4.059
layer_31_expert_9	4.061
layer_15_expert_14	4.091
layer_21_expert_11	4.101
layer_31_expert_11	4.113
layer_31_expert_7	4.156
layer_12_expert_6	4.183
"""

# Parse full expert list
pattern = re.compile(r'layer_(\d+)_expert_\d+\s+[\d\.]+')
lines = [line for line in expert_text.strip().splitlines() if pattern.match(line)]

# Build mapping of layer -> expert ranks
layer_ranks_by_layer = {i: [] for i in range(32)}
for rank, line in enumerate(lines, start=1):
    layer = int(re.match(r'layer_(\d+)', line).group(1))
    layer_ranks_by_layer[layer].append(rank)

# Layer-level ordering by entropy (0 = lowest)
layer_order = [4,29,6,7,23,26,5,17,27,25,28,21,12,10,13,16,9,20,19,15,24,11,22,14,8,30,18,31,0,1,3,2]
layer_rank_map = {layer: idx for idx, layer in enumerate(layer_order)}

# Plot
fig, ax = plt.subplots(figsize=(12, 6))

# Expert entropy ranks scatter
for layer, ranks in layer_ranks_by_layer.items():
    ax.scatter([layer]*len(ranks), ranks,
               color='b', s=8, alpha=0.5)

# Overlay layer-level ranks on secondary y-axis
ax2 = ax.twinx()
layers = list(range(32))
layer_ranks = [layer_rank_map[layer] for layer in layers]
ax2.scatter(layers, layer_ranks,
            color='g', marker='x', s=60)
ax2.set_ylabel('Layer Entropy Rank (0 = Lowest)')
ax2.set_ylim(-1, 32)

# Labels and formatting
ax.set_xlabel('Layer')
ax.set_ylabel('Expert Entropy Rank (1 = Lowest)')
ax.set_title('Expert Entropy Ranks by Layer with Layer-Level Rank Overlay')
ax.set_xticks(layers)
ax.set_ylim(0, len(lines) + 10)

plt.tight_layout()
# plt.show()

# Save the figure
save_path = 'moe_layers.png'
plt.savefig(save_path)

print(f"Plot saved to: {save_path}")